---
# kubectl
- name: Add Kubernetes GPG key
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes repository
  copy:
    content: |
      deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /
    dest: /etc/apt/sources.list.d/kubernetes.list

# helm - install via script (apt repo has DNS issues)
- name: Install helm
  shell: |
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  changed_when: false

# terraform
- name: Add HashiCorp GPG key
  shell: |
    curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /etc/apt/keyrings/hashicorp.gpg
    chmod 644 /etc/apt/keyrings/hashicorp.gpg
  args:
    creates: /etc/apt/keyrings/hashicorp.gpg

- name: Get architecture for hashicorp
  command: dpkg --print-architecture
  register: hashi_arch
  changed_when: false

- name: Add HashiCorp repository
  copy:
    content: |
      deb [arch={{ hashi_arch.stdout }} signed-by=/etc/apt/keyrings/hashicorp.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main
    dest: /etc/apt/sources.list.d/hashicorp.list

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install cloud tools
  apt:
    name:
      - kubectl
      - terraform
    state: present

# aws-cli - install via official installer (apt version is outdated)
- name: Get system architecture for AWS CLI
  command: uname -m
  register: aws_arch
  changed_when: false

- name: Install aws-cli
  shell: |
    cd /tmp
    curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-{{ aws_arch.stdout }}.zip" -o "awscliv2.zip"
    unzip -q -o awscliv2.zip
    ./aws/install --update
    rm -rf aws awscliv2.zip
  args:
    creates: /usr/local/bin/aws
  changed_when: false

# gcloud-cli
- name: Add Google Cloud GPG key
  shell: |
    curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /etc/apt/keyrings/cloud.google.gpg
    chmod 644 /etc/apt/keyrings/cloud.google.gpg
  args:
    creates: /etc/apt/keyrings/cloud.google.gpg

- name: Add Google Cloud repository
  copy:
    content: |
      deb [signed-by=/etc/apt/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main
    dest: /etc/apt/sources.list.d/google-cloud-sdk.list

- name: Update apt cache for gcloud
  apt:
    update_cache: yes

- name: Install gcloud-cli
  apt:
    name: google-cloud-cli
    state: present

# gh (GitHub CLI)
- name: Add GitHub CLI GPG key
  shell: |
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /etc/apt/keyrings/githubcli.gpg
    chmod 644 /etc/apt/keyrings/githubcli.gpg
  args:
    creates: /etc/apt/keyrings/githubcli.gpg

- name: Get architecture for GitHub CLI
  command: dpkg --print-architecture
  register: gh_arch
  changed_when: false

- name: Add GitHub CLI repository
  copy:
    content: |
      deb [arch={{ gh_arch.stdout }} signed-by=/etc/apt/keyrings/githubcli.gpg] https://cli.github.com/packages stable main
    dest: /etc/apt/sources.list.d/github-cli.list

- name: Update apt cache for gh
  apt:
    update_cache: yes

- name: Install gh (GitHub CLI)
  apt:
    name: gh
    state: present
